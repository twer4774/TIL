# 08. AWS 데이터베이스 서비스
## 관계형 데이터베이스
- 데이터베이스 관리 시스템(DBMS)는 데이터 저장, 조직화, 인출과 관련한 제반 업무 담당
- 행과 열로 구성된 테이블에 저장
- 규칙
	- 일관성 : 테이블의 행은 서로 명확하게 구분한다.
		- 열의 값은 그룹 또는 배열 값을 반복해서는 안된다.
		- 어떤 열의 값을 모를 때 NULL을 사용한다.
- DML : 데이터 삽입, 업데이트, 삭제, 수정 - SELECT, INSERT, DELETE, UPDATE
- DDL : 테이블 구조 생성, 변경, 드롭 - CREATE TABLE, DROP TABLE, ALTER TABLE

## Amazon RDS의 개요
- Aurora MySQL, Aurora PostgreSQL
- Oracle, SQL Server, MySQL, PostgreSQL, MariaDB
- 관계형 데이터 호스팅시나리오
	1. 온프레미스 데이터 센터에 데이터베이스 호스팅
	- 전원 관리, 네트워크 환경설정, 서버환경설정, 운영체제 설치 등 데이터 센터 운영을 위한 제반 업무를 모두 수행해야한다.
	2. Amazon EC2 서버에 데이터베이스 호스팅 
	- 사용자는 앱 최적화, 확장성, 고가용성, DB 백업, DB SW 패치, DB SW 설치, OS 패치 관리
	- AWS는 OS 설치, 서비스 유지보수, 서버 랙 및 스택관리, 전원, HVAC, 네트워크 관리
	3. Amazon RDS를 이용해 데이터베이스 호스팅
	- 사용자는 어플리케이션 최적화만 신경쓴다.
	- AWS가 나머지 제반사항 관리
- RDS의 주요 장점
	- 인프라 관리 불필요
	- 즉각적인 프로비저닝
	- 확장성 관리 : Scale Up / Down
	- 비용효율성
	- 어플리케이션 호환성
	- 고가용성 : Multi AZ
	- 보안 유지 : 암호화 지원

## 데이터베이스 호스팅 : Amazon EC2 VS Amazon RDS
- RDS의 단점 : OS에 접근 불가. 슈퍼 유저권한을 얻을 수 없다.
- RDS를 추천하는 경우
	- 비즈니스 본연의 가치에 집중하려는 경우
	- DB 관리업무를 원치 않는 경우
	- 하이레벨 튜닝 및 스키마 최적화 등의 업무만 처리하려는 경우
	- 회사 내 DB 관리 역량이 충분치 않은 경우
	- 푸시 기반 다중 AZ 복제환경을 이용하는 경우
	- 백업 및 복원 자동화를 원하는 경우
- EC2를 추천하는 경우
	- DB 인스턴스에 대한 완전한 통제권을 원하는 경우
	- OS의 통제권을 원하는 경우
	- 백업, 복제, 클러스터링 등에 대한 완전한 통제권을 원하는 경우
	- 기업의 RDBMS 엔진의 주요기능과 옵션이 Amazon RDS의 제공 수준을 넘어서는 경우

## Amazon RDS에서의 고가용성 구현
- HA(High Availability) 아키텍처 지원
- 기업의 중요 데이터를 저아하는 경우 HA 환경설정이 필요하다.
- 아키텍처 옵션
	- 가장 단순한 아키텍처 : 싱글 AZ 배포 -> 개발환경에서 사용
	- 고가용성 아키텍처 : 멀티 AZ 배포 -> Master(기본DB)가 대부분의 트래픽 처리 / Stand By DB 존재

## Amazon RDS에서의 확장성 구현
### 인스턴스 타입 변경
- 확장성 조절을 위한 가장 간단한 방법
- Downtime : 인스턴스 클래스 변경 시 발생하는 가동 정지 시간
- RDS는 Auto Scaliing과 통합되지 않는다. (Cron jon으로 실행 불가)
	- Lambda로 오토스케일링 정의 후 사용 가능
### 읽기 사본, Read Replica 활용
- RDBMS 엔진에 따라 최대 15개의 읽기사본 생성 가능
- read-only 쿼리 부담을 줄여 마스터 DB의 워크로드 감소
- 마스터 DB가 다운됐을 때 사본이 마스터로 승격 가능 (비동기 복제 -> 데이터 손실가능성 존재)

## Amazon RDS에서의 보안성 구현
### Amazon VPC와 Amazon RDS
- DB는 항상 방화벽으로 보호해야하므로 처음부터 프라이빗 서브넷에 생성하는 것이 좋다.
- VPC 내에서 실행되는 DB를 연결하는 방법
	- VPC 내에 구현된 데이터 센터를 VPN으로 연결해 하이브리드 방식으로 DB 연결 가능
	- Direct Connect로 데이터 센터와 AWS 지전을 연결하면, 일관된 성능의 연결상태 유지 가능
	- 두 개의 VPC를 피어 방식으로 연결한 뒤 하나의 VPC에는 어플리케이션을 두고, 다른 VPC에는 DB를 두어 서로 연결할 수 있다.
	- VPC에 Internet Gateway를 부착하고, DB에 대한 퍼블릭 접근 허용 가능
	- VPC에 부착한 서브넷의 라우트 테이블을 이용해 VPC의 라우팅 방식을 정의 가능
### Amazon RDS에서의 암호화
- RDS는 저장 상태의 데이터에 대한 암호화를 제공
- RDS의 암호화된 인스턴스는 데이터보안을 위한 추가적인 레이어를 통해 비인가 접근 차단
- 암호화 종류 - DB인스턴스 스토리지 암호화, 자덩화된 백업 암호화, 레플리카 암호화, 스탠바이 DB 암호화, 스냅샷 암호화
- RDS 암호화 보안 점검 측면에서의 주의 사항
	- DB 생성시에만 암호화 진행 가능 -> 이미 실행중인 경우 재생성 필요
	- DB 암호화 시 삭제 불가
	- 마스터 DB와 레플리카는 반드시 암호화해야 한다.
	- 다른 리전으로 암호화 DB를 복사 불가. 하나의 리전에서 KMS로 암호화한 대상을 다른 리전에 복사할 수 없다.
	- MySQL의 암호화 DB를 Aurora MySQL로 마이그레이션할 수 있다.
### 백업, 복구, 스냅샷
- 백업 보존 기간: 35일, 서포트 티켓으로 연장 가능
- 스냅샷은 자동 일정관리 불가. 사용자가 직접 스냡샷 생성
- 스냡샷은 S3에 저장되며, 사용자는 스냅샷으로 DB 복원 가능하다.
- 암호화 된 DB의 스냡샷을 생성한 경우. DB 복원 후 암호화된 DB가 된다.
### 모니터링
- RDS는 모니터링 된 모든 성능 지표를 Amazon CloudWatch에 전송
- 표준 모니터링 : RDBMS 엔진에 따라 15~18개의 성능 지표 모니터링 가능
- 강화 모니터링 : 좀 더 세분화된 성능 지표가 필요할 때 선택하는 옵션으로 표준 모니터링의 성능 지표 외 37개의 지표를 추가해 총 50개의 성능지표를 제공받을 수 있다.
- 1초단위로 갱신된다.
- 이벤트 노티피케이션 : RDS 인스턴스에서 발생하는 이벤트를 신속하게 확인할 수 있는 옵션
- 퍼포먼스 인사이트 : RDS의 모니터링 기능을 확장한 것으로 DB 성능 시각화

## Aurora
- MySQL, Postgre SQL 호환 관계형 DB
- 완전 분산형 및 자가 진단형 스토리지 시스템으로 성능, 신뢰성 보장
- 기존 RDS들과 다른 점 : 세 개의 서로 다른 AZ에 있는 여섯개의 서로 다른 스토리지 레이어에 자동으로 복제하며, 별도의 비용 없이 6번의 미러링을 한다.

## Amazon Redshift
- Data Ware House 솔루션으로 비즈니스 인텔리전스 활동에 맞게 설계
- 보통의 DB는 트랜잭션에 초점. 데이터 웨어하우스는 데이터쿼리 및 분석에 초점
- 데이터웨어하우스는 데이터의 소비 주체이며, 온라인 분석처리 시스템(Online Analytical Processing)으로 불리기도 하낟.
- 장점
	- 신속성 : Redshift는 컬럼형 스토리지로서 높은 쿼리성능 제공. 쿼리는 병렬 처리 가능
	- 저렴함 : TB 당 $1000
	- 우수한 압축성 : Redshift는 서버에서 4배 정도의 높은 압축 기능 제공
	- 관리형 서비스
	- 확장성 : 분산형 병렬식 아키텍처를 이용해 처리 성능에 대한 요구사항을 수평적 확장 방식으로 제공
	- 보안성 : 저장중인 데이터 및 전송중인 데이터 모두 암호화
	- 존 맵 기능 : 각 블록의 최소 및 최대 값을 추적해 이번에 처리해야 할 쿼리와 무관한 데이터를 포함한 블록 처리 대상에서 제외하는 방식으로 불필요한 I/O 최소화
- 아키텍처
	- 리더 노드와 컴퓨트 노드로 구성
	- 클러스터마다 하나의 리더 노드 존재
	- 컴퓨트 노드는 최대 128개 생성 가능
- 클러스터 크기 조절
	- 덴스 스토리지 또는 덴스 컴퓨트 중 원하는 클러스터 타입 선택
	- 덴스 컴퓨트 : 비즈니스가 빠른 처리를 원할 경우
	- 데이터 미러링 기능은 이미 포함되어 있다.
- 네트워킹
	- Redshift 클러스터는 VPC 내에서 실행될 수 있다.
	- VPC를 이용해 격리된 구조 생성 가능 -> 서브넷 그룹 선택 : 프라이빗/퍼블릭 속성
- 암호화
	- 암호화된 클러스터는 비활성화로 변경 불가
	- 암호화된 클러스터의 스냅샷도 암호화
- 보안
	- RDMS 중 하나이므로, 슈퍼 유저 또는 권한을 지닌 유저 생성
	- 하나 이상의 스키마를 지닐 수 있으며, 각 스키마는 테이블과 객체를 지닌다.
	- Redshift를 사용하기 위해 IAM 유저, 롤, 그룹 등을 포함한 IAM 정책을 생성할 수 있다.
- 백업 및 복구
	- 클러스터의 스냅샷 형태로 자동 백업 -> S3 저장
	- 8H or 5GB 증가시마다 스냅샷 생성 가능
- 데이터 배분 전략
	- 클러스터 내에 여러 노으데 데이터를 배분하는 옵션
		- KEY : 정의된 열의 Hash 값인 배포키에 따라 노드 슬라이스
		- ALL : 각 노드의 첫 번째 슬라이스에 전체 테이블의 복사본 배분
		- EVEN : KEY 와 ALL의 절충점. 저차원의 소규모 테이블. Join 또는 Group By 명령을 사용할 필요가 없는 테이블, 전체 데이터를 합산하는 쿼리를 사용하지 않는 테이블에 적합

## Amazon Dynamo DB
- 확장성 및 개발의 신속성을 제공하는 고성능의 완전 관리형 NoSQL
- Document Structures (JSON, XML, HTML) 및 Key-Value Data Structures (Key, Value) 제공
- 주요 사용 방식 : 광고 서비스에서 브라우저의 쿠키 상태 정보 수집, 세션 저장 등
### 장점
- 확장성 : 기본적인 확장성 + 스케일 업/다운
- 고나리형 서비스
- 신속성, 일관된 성능 : SSD를 사용하므로 지연시간이 짧다.
- 세분화된 접근 제어 : AWS IAM과 통합해 기업 내 모든 사용자를 위한 세분화된 접근 제어 기능 제공
- 비용 효율성 : 사용자는 자신의 사용량 및 프로비저닝한 IO 처리 성능에 대한 비용만 부담
- 다른 AWS 서비스와의 통합
### 주요 개념 및 용어
- 테이블 : 데이터 조직화 및 저장을 위한 가장 기본적인 구조
- 아이템 : 기본키와 속성 (key, value)
- Dynamo DB는 스키마가 없으므로 테이블 내의 데이터 아이템은 동일 속성 또는 동일한 속성 수로 이뤄질 필요가 없다.
- 테이블 내 각 아이템은 최대 400KDB이내의 다수의 요소를 포함한 튜플로 표현
	- 아이템 : 단일 기본키 또는 복합키로 구성. 다수의 속성 포함
		- 속성의 수는 제한이 없지만, 속성이름 + 속성값 = 아이템 합산 용량 <= 400KB 
	- 속성. :데이터 아이템과 연관된 각 속성은 하나의 속성이름과 하나의 값 또는 값의 집합으로 구성
- Number, String, Binary, Boolean  네가지 스칼라 타입 지원
- 파티션 키 : 기본키, 아이템의 파티션 키는 해시 속성으로 부르며, 해시속성은 DB가 해시함수를 이용해 파티션마다 동일한 수의 속성 데이터를 배분한다. 
	- 하나의 테이블에는 단 하나의 파티션 키만 존재한다.
- 파티션 키와 정렬키 조합 : 두 개의 속성이 결합된 키로 ‘복합 기본키’라 부른다
	- 첫번째 속성은 파티션 키, 두번째 속성은 정렬키로 사용
	- 동일 파티션키를 지닌 아이템은 하나의 정렬 그룹으로 관리되고, 아이템 그룹은 정렬키 순으로 정렬
- 쓰기 성능 : 초당 1KB / 읽기 성능 : 초당 4KB
###  전역 보조 인덱스
- 테이블의 기본키가 아닌 파티션 키 또는 파티션 정렬 키를 포함한 인덱스
- 두 가지 타입의 보조 인덱스
	- 지역 보조 인덱스(local secondary index) : 테이블 내에서 파티션 키는 같지만 정렬 키가 다른 인덱스이며, 동일한 파티션 키를 지닌 테이블 파티션으로 인덱스 범위가 제한된다는 측면에서 로컬 또는 지역속성을 띤다.
	- 전역 보조 인덱스(global secondary index) : 테이블 내에서 파티션 키 및 파티션 정렬 키가 모두 다른 인덱스이며, 인덱스 범위가 테이블 내 모든 아니템, 모든 파티션이라는 측면에서 글로벌 또는 전역 속성을 띤다.
### 일관성 모델
- 각 테이블 마다 세 개의 다른 지역에 사본을 분산 저장 -> 고가용성, 고신뢰
-  읽기 모델 선택
	- 최종적 일관성의 읽기 : 읽기 처리 성능을 최대화한 모델. 최신 내용 갱신에 약간의 지연 발생
	- 강한 일관성의 읽기 : 읽기 요청에 대해 언제라도 최신의 쓰기 결과 반환
### 글로벌 테이블
- 지역별 니즈를 신속하게 반영할 수 있도록 높은 수준의 읽기 및 쓰기 성능 제공
- 멀티 리전 환경에서 데이터 중복 구현을 통해 리전별 재해에서 가용성 유지를 제공
### Amazon DynamoDB Streams
- 멀티 마스터 DB 구조를 구현하거나 각 마스터가 동기화 상태를 유지하도록 함
### Amazon Dynamo DB 가속기. DAX
- 완전 관리형. 고가용성. 인메모리 캐시 서비스 제공

## Amazon ElasticCache
- 클라우드에서 인메모리 캐시를 운영, 배포하기 위한 웹 서비스
- 샤딩 기법을 통해 메모리 확장성 관리
- 인메모리 캐시는 중요한 데이터를 빠르게 접근할 수 있도록 메모리에 저장해 어플리케이션의 성능 향상
- 두 가지 종류의 인메모리 키 벨류 엔진
	- Memcached : 웹 캐싱 부문의 표준, 멀티 스레드 기능 제공
	- Redis : 오픈소스 키 벨류 스토어. 디스크 지속기능을 지니고 있어 오랫동안 유지해야 하는 데이터에 적용 가능
- 실무적인 사용
	- Redis는 복제 및 디스크 지속 등의 기능을 이용해 RDB 처럼 활용
	- Redis ElasticCache 클러스터는 장애 대응 기능을 포함한 스테이트풀 개체로 관리
	- Memcached 클러스터는 어플리케이션에서 DB와 별개의 요소처럼 작동하므로 DB와 직접 소통할 수 없고, DB에 대한 정보도 지니지 않는다.
	- 사용자는 처음에 단일 ElasticCache노드를 이용해 어플리케이션을 테스트한 뒤 ElasticCache 클러스터를 수정해 클러스터 노드를 추가하는 것이 좋다.
