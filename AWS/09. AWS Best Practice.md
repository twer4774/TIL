# 09. AWS Best Practice
클라우드 아키텍처 구현시 AWS의 Well-Architected Framework(WAF)의 장점
- 신속한 개발과 배포
- 위험 감소
- 정보 기반의 의사결정
- 최선의 AWS 활용 전략
WAF의 운영 원칙 : 운영우수성 원칙, 보안성 원칙, 성능원칙, 신뢰성 원칙, 비용최적화 원칙

## 운영 우수성 원칙 (Operation Excellence)
- 시스템이 비즈니스를 얼마나 잘 지원하고 있는가 측정
- 운영팀에서 비즈니스 목적 상 중요한 어플리케이션의 우선순위를 두고 지원 수준 결정
- 세부실천 사항
	- 운영업무의 코드화 : 스크립트 작성, AutoScaling
	- 운영 업무의 문서화
	- 지속적인 작은 변화의 실천
	- 실패 상황 고려
	- 운영실패 사례를 통한 학습 
### 준비
- 비즈니스의 이해 및 우선순위 설정
- 예정된, 예기치 않은 downtime에 대응 -> 실패가능성을 염두에 둔다.
### 운영
- 운영상의 성공은 운영 결과 및 미리 정의한 성능 지표로 평가
- 성능 지표 : 어플리케이션의 성능 기준선 또는 비즈니스에 도움이 된 수준
- 운영팀의 대시보드에 필요한 4가지 서비스
	- Amazon CloudWatch logs : EC2 인스턴스, AWS CloudTrail, 다른 리소스의 로그를 모니터링하고 저장
	- Amazon ES : 로그 분석, 어플리케이션 모니터링을 위한 Elasticsearch의 배포, 운영, 보안, 확장 지원
	- Personal health Dashboard : 사용자 개인에 영향을 미칠 수 있는 이벤트에 대안, 경고, 대응, 가이드 제공
	- Service health Dashboard : 서비스 가용성과 관련된 주요 정보로 1분단위로 제공
### 발전
- 지속적인 개선을 위한 새로운 기술 추가 및 아키텍처 개선

## 보안성 원칙
- 강력한 접근 관리 전략 수립 : AIM 활용. 최소수준의 권한 부여
- 추적기능 활용 : AWS CloudTrail을 이용해 클라우드 내 주요 활동 정보 수집
- 모든 레이어에 대한 보안 : 웹, 앱, DB 티어별 보안
- 데이터 보안 : 데이터 이동 시 암호화, SSL, TLS 기법 활용
### 보안성 원칙의 베스트 프랙티스
- IAM 활용
- 탐지 제어 서비스 활용 : 시스템에 대한 침해시도 또는 위협을 탐지하기 위해 탐지제어 기능 활용
	- 로그 수집 및 분석 : 리소스와 인스턴스의 로그데이터 수집 가능
	- 노티피케이션 및 워크플로와 감사 업무 통합 관리
	- 보안팀의 탐지 제어 기능 구현에 도움을 주는 서비스
		- AWS Config : 리소스 인벤토리. 환경설정에 대한 시간 순 기록, 보안 및 거버넌스를 위한 환경설정 변경 노티피케이션 등의 기능을 제공
		- AWS Config Rule : 리소스 환경 설정 규칙
		- AWS CloudTrail : 사용자의 계정에 대한 AWS API의 호출 기록 및 로그 관리를 위한 서비스
		- AWS CloudWatch : 성능 지표의 시각화
		- VPC Flow Logs : VPC, VPC 서브넷 또는 ENI 접속과 관련된 모든 트래픽은 CloudWatch Logs에 기록
		- Amazon Inspector : 보안상의 약점. 어플리케이션 및 운영 시스템의 잘못된 환경 설정등 프로그래밍 방식으로 찾을 수 있는 도구
	- 인프라 보호 기능 활용
		- 네트워크 및 호스트 레벨 경계 보호 가능
		- VPC, 서브넷, 라우팅 테이블, NACL, 게이트웨이, 시큐리티 그룹 설정
		- 사용자는 AWS System Manager로 보안 환경 설정 및 유지보수 업무 수행
		- IAM 정책 정의로 AWS 엔드포인트 보안 환경설정 가능
	- 데이터 보호 기능 활용
		- 암호화 및 토큰화
	- 침해 대응 기능 활용 : Web Application Firewall 및 Shield 이용

## 성능 원칙
- 설계 원칙
	- 간단한 조작으로 글로벌화 달성
	- 서버리스 등 신기술 활용
	- 최신의 고급 기술 활용
	- 다수의 기술 활용
- 성능 효율성
	- 1단계 : 선택
		- 워크로드를 파악하여 적절한 서비스 선택 ex. 메모리 집약형, EC2(I/O 처리) + PIOPS EBS
		- 세부. 요소
			- 컴퓨트 : 인스턴스, 컨테이너, 함수 등 세가지 형태로 제공. 연산 능력
				- 클라우드 환경에 적합한 어플리켕션을 구현할 계획이라면 API Gateway와 Lambda 이용
			- 스토리지 : 데이터 접근 방식, 접속 빈도, 데이터 업데이트 주기, 처리성능 등 고려
			- 네트워크 : 특정 시스템을 위한 최적의 네트워크 솔루션은 지연시간, 처리성능에 따라 다름
				- 네트워크 최적화 기법 - EBS 최적화 인스턴스 -> 플레이스먼트 그룹 제공
					- 플레이스먼트 그룹 : 조직으로 표현한 단일 AZ 내 인스턴스 그룹으로, 이를 지원하는 인스턴스를 이용해 20Gbps 네트워크 사용 가능
			- 데이터베이스
	- 2단계 : 검토
		- AWS CloudFormation 템플릿 등으로 기업 인프라를 일련의 코드로 정의 -> 신속하게 확장, 반벅 가능
		- CI/CD 인프라 배포 -> 기술 및 비즈니스 성능지표 준비, 모니터링
		- 주기적인 벤치마킹 테스트로 성능 개선 (스크립트를 통해 테스트)
	- 3단계 : 모니터링
		- Cloud Watch는 모니터링 및 노티피케이션 전송 기능을 제공하며, Kinesis, SQS, Lambda 등으로 적절한 대응. 행동을 실행하도록 자동화할 수 있다.

## 신뢰성의 원칙
신뢰성 : 서비스 레벨 합의서 (SLA) 상의 요구 사항을 준수할 수 있는 아키텍처를 설계하기 위한 신뢰성
- 비즈니스 유닛이 감당할 수 있는 리소스 고갈 수준 파악. RTO(Recovery Time Object) 및 RPO(Recovery Point Object) 레벨에서의 업무 정상화 방법 포함
- 클라우드에서 신뢰성의 원칙을 구현하기 위한 5가지 세부원칙
	- 복원 절차 검증 : 모든 실패 상황을 시뮬레이션 하고, 실패 상황을 어떻게 극복할수 있는지 검증
	- 실패 복원의 자동화 : 최대한 많은 실패 복원 업무를 자동화
	- 리소스의 수평적 확장 : 낮은 성능의 서버를 여러 대 두어 고가용성 유지
	- 요구성능 및 용량 구체화 : 사용량 증가에 따라 리소스 추가과정 자동화
	- 시스템 변경 업무의 자동화 : 시스템에 대한 모든 변경 업무는 자동화
### 신뢰성 원칙의 베스트프랙티스 
- 신뢰의 토대 구축 (Lay the Foundation)
	- 비즈니스 목표 파악
	- 네트워크 용량 계획
		- 리전 당 하나 이상의 VPC를 사용할 수 있도록 충분한 IP 주소공간 확보
		- VPC 내에서 멀티 AZ 확장을 위한 멀티 서브넷 공간 확보
		- VPC 내에 여분의 CIDR 블록 공간을 둬 미래의 필요에 대비
		- 교차계정연결 방식을 사용할 수 있으므로 비즈니스 유닛마다 각자의 계정을 지닌다.
			- 교차 계정 연결 - VPC로 서비스 공유
		- 실패 가능성 및 정상화 고려
	- 어플리케이션 가용성 설계시 고려사항
		- 장애 격리 지역 활용 : AWS는 AZ에 장애 격리를 위한 전용 구조 제공
		- 중복 구현 요소 활용 : AWS의 설계 원칙 중 하나는 물리 인프라에서 단일 실패 지점을 만들지 않는다.
		- 관리형 서비스 활용
- 변경 대응 관리 (Implement Change Management)
	- 블루-그린 배포 : 두 개의 배포 스택이 병렬적으로 실행
		- 새버전/구버전 -> 1/9 비율로 트래픽을 보내며, 새 스택에 오류 발생 시 구 스택으로 트래픽을 보낸 뒤 상황 개선 시 다시 새 스택으로 트래픽을 보낸다.
		- 카나리아 배포(Canary Deployment) : 고객 중 일부를 새 버전으로 라우팅해 변경 또는 오류 가능성 검증
		- 기능별 활성화 : 고객이 필요 기능으로 인지하지 못하는 기능을 비활성화한 채로 배포 후 추후에 기능 활성화
- 장애 대응 관리
	- 모든 레이어를 평가해 특정 스택 또는 컴포넌트 오작동 시 어플리케이션ㅇ ㅔ미치는 영향을 검증하거나 AZ 실패. Direct Connect 실패, EC2 서버 실패, 특정 드라이브 실패 상황 고려
	- 장애복구 전략(DR) 수집
	- 정기적인 백업 및 백업 파일로 모든 기능이 정상적으로 회복될 수 있는지 확인
	- DR 시뮬레이션 테스트를 통해 다른 리전에서 인프라 재 가동시 걸리는 시간 테스트
	- Cloud Formation을 통해 다른 리전의 데이터백업 및 다른 리전에서의 인프라 배포 자동화

## 비용 최적화 원칙 (Cost Optimization Pillar)
- 미사용 리소스 및 비효율 리소의 제거를 통해 비용 절감
- 비용 최적화를 위한 세부 원칙
	- 최적의 소비 모델 선택 : ex) 개발자의 출, 퇴근 시간 동안만 개발 환경 실행 / 비수기에 일부 인스턴스 셧다운
	- 관리형 서비스 사용 : 인프라 보유 부담을 줄이고, 서버리스 서비스를 통해 비즈니스에 집중
	- 전반적인 효율성 측정 : 비즈니스의 실제 전달가치를 통해 비용 효율성 측정
	- 비용 분석 : 클라우드 비용과 투자 성과를 비교해 투자 대비 수익률 계산
	- 전통적인 데이터 센터 투자 감축
- 비용 효율적인 리소스 찾기
	- 최소 리소스를 이용해 일정기간 워크로드를 실행해보고 Scale Up / Down 조절
	- 기업의 비즈니스 로직에 따라 온디맨드 리소스 스팟 인스턴스, 예약 인스턴스 등 다양한 구매 옵션 선택 가능
	- 비즈니스 니즈에 맞는 엔드 유저와 가까운 지역의 리전 이용
		- ex) e-커머스 또는 웹 사이트의 경우 타깃 유저 인접 리전 선택을 통해 지연 시간 등 주요 성능 지표 수준을 높일 수 있다.
- 수요와 공급의 일치
	- 온프레미스 환경에서는 절정수요(Peak Demand)에 대비하기 위해 평균 필요량이상의 과잉 프로비전을 해야한다.
	- 클라우드에서는 자동으로 리로스를 프로비전 할수 있다.
	- Auto Scaling, 소규모 RDS -> 인스턴스 클래스 변경
- 비용 지출 내역 파악
	- 데이터 전송 비용 또는 Direct Connect 비용 등 세부적인 비용 요소를 모두 파악하는 것이 중요
- 시간 경과에 따른  최적화 : 지속적인 모니터링, 개선 작업 필요

## AWS베스트 프랙티스
- 클라우드 배포 시 3가지 방법 이용 가능
	- 클라우드 일부 이전, 클라우드 최적화, 클라우드 네이티브 아키텍처
- 실패 대응 설계 (Design for Failures)
	- 스토리지 레이어의 경우 RAID등의 기술을 이용해 데이터 미러링 체계를 구현해야 한다.
	- DB 티어는 고가용성 유지, 어플리케이션 티어는 다수의 EC2 인스턴스 활용으로 실패상황 대비
- 모든 레이어에 보안성 구현
- 다중 스토리지 옵션의 활용
	- S3 대규모 데이터 객체
	- Glacier 데이터 아카이브
	- CloudFront 콘텐츠 배포
	- DynamoDB : 비관계형 데이터
	- Ephemeral Storage : 임시 보관 데이터
	- EBS : 스냅샷 기능의 영구적 블록스토리지
	- RDS : 자동화 RDB
	- Aurora 
	- Redshif : 데이터 웨어하우스 워크로드
- 클라우드 리소스의 탄력성 구현
	- AWS 클라우드는 절정 수요에 상관없이 사용자가 필요한만큼 프로비저닝
	- Auto Scailing, Elastic Load Balacing, DynamoDB(세션저장 등)
- 병렬 처리 기법의 활용
	- SNS와 SQS를 이용하면 메시지 및 노티피케이션을 통해 서로 소통하며 병렬적으로 워크로드 처리 가능
	- 이미지 업로드 시 토픽을 통해 섬네일 생성, 이미지 인식, 메타데이터 저장 등 병렬적인 업무 처리 가능
		- 멀티 스레드 및 동시 병행 처리 활용: 클라우드에 다수의 요청을 전송한 경우 병렬 처리
		- 맵리듀스 잡 활용 : 빅데이터 처리를 위한 Amazon EMR은 EC2 인스턴스에서 MapReduce 프레임워크에 포함된 Hadoop을 자동으로 실행
			- 하나의 프로세싱에 포함된 데이터를 작은단위(map)로 나누어 처리하고, 처리된 데이터를 축소 및 재결합해 제공(reduce)
		- ELB를 이용한 워크로드 배포 : ELB를 이용해 싱글 AZ 또는 멀티 AZ 환경에 있는 EC2 인스턴스에 트래픽을 배분할 수 있다.
		- Kinesis를 이용한 데이터 동시 병행 처리 : 분석과 동시에 결과를 S3에 저장
- 느슨하게 연결된 아키텍처 : 각 요소를 느슨하게 연결 -> 아키텍처의 확장성을 높인다.
- AWS 리소스의 활용 전략
	- 멀티 AZ 활용 시나리오
		- 2개의 AZ 활용 시나리오 : 4대의 웹 서버를 2개의 AZ에 각각 배포하고 둘 중 하나의 AZ 다운 시 리솟스 상실 확률 50%