# 06. 오토 스케일링
## 장점
- 동적 스케일링
- 최상의 사용자 경험 제공 가능
- 헬스 체크과 서버플릿 관리
	- 서버플릿 : EC2의 집합
- 로드밸런싱
- 타깃트래킹 : 특정 타깃에 대해서만 오토스케일링 가능

## 실행환경
- 일종의 템플릿으로, AMI 상세정보, 인스턴스 타입 키페어, 시큐리티 그룹 등 인스턴스에 대한 모든 정보를 담고 있다.

## 오토스케일링 그룹 : Scale Up/Down 그룹
- 인스턴스 레벨 유지
	- 기본 스케일링 계획
	- 항상 실행 상태를 유지하고자하는 인스턴스의 수 정의
- 수동 스케일링
	- API나 CLIL등으로 수동 스케일링 가능
	- 오토 스케일링에 맞지 않으므로 추천하지 않는 방식
- 요구별 스케일링
	- 시스템의 요구수준에 맞추는 방식
	- AWS 클라우드 와치가 모니터링 하는 CPU, 디스크 Read/Write, 네트워크 유입/유출 등 주요 지표를 바탕으로 스케일링 규칙 정의
	- 스케일링 정책을 정의할 때는 항상 2가지 정책을 작성한다. (Scale up/down)
### 심플 스케일링
- 단일 스케일링 정책에 따라 스케일 up/down 정책 정의
- 쿨 다운 기간 : 인스턴스 시작 또는 정지를 위한 대기 시간
- CPU 이용률, 디스크 읽기/출력 성능, 네트워크 입출력 성능 등과 관ㄹ녀된 경고 메시지 선택
- 정의 및 변경 사항
	- 정확한 용량 : 정책으로 설정된 인스턴스 만큼 수량 증가
	- 숫자 지정 용량 변경
	- 퍼센트 단위의 용량 변경 : 퍼센트 단위로 현재 용량 증가/감소
### 단계별 심플 스케일링 : 심플 스케일링과 유사하며 일부 절차만 다름
### 타깃 트래킹 스케일링 정책
- 성능 지표에 따라 스케일링 (ex. CPU 이용률을 성능지표로 선택하고, 타깃 값을 50%로 설정)

## 인스턴스 삭제 정책
- 서버 플릿에서 가장 오래된 인스턴스 삭제 -> 장점: 패치수준이 낮은 인스턴스를 삭제하여 최신 상태 유지 가능

## 일래스틱 로드 밸런싱
- 장점
	- 탄력성 : 수작업 필요없이 자동 확장
	- 통합성 : 다양한 AWS 서비스와 통합해 사용 가능
	- 안정성 : 통합 인증관리, SSL 부호화, 포트포워딩 등 다수의 보안 제공
	- 고가용성 : IP 트래픽 분산, AZ 분산 배포
	- 저렴
### ELB 작동 방식
- ELB 인스턴스는 다중 AZ 구현
- 로드밸런서는 기본적으로 다중 AZ 환경 배포
- 다중 AZ 환경에 개별 ELB VPC 내에서 다수의 로드밸런서를 배포하는 방식으로 고가용성 구현 간으
- AWS는 로드밸런서와 관련된 모든 업무를 자동으로 관리
- 별도의 비용 없음
### 로드밸런서의 유형
- 네트워크 로드 밸런서 (Network Load Balancer)
	- TCP 로드밸런서로도 부른다.
	- OSI 모델 Layer 4에서 동작
	- 연결기반 로드 밸런서이며, EC2 인스턴스, 컨테이너, IP 주소 등 연결 관리
	- 패킷의 내용까지는 확인하지 않는다.
	- TCP와 SSL 모두 지원
	- 클라이언트 측 소스 IP주소를 지니고 있으므로 백엔드를 통해 클라이언트측의 IP 확인 가능
	- X-Forwarded-For 헤더는 지니지 않으므로 프록시 프로토콜이 소스 IP주소 또는 Destination IP주소, 요청 포트의 역할을 대신한다.
- 어플리케이션 로드 밸런서 (Application Load Balancer)
	- OSI Layer 7에서 동작
	- HTTP/HTTPS 지원
	- 어플리케이션으로부터 패키지가 전달되면, 헤더로 받은 두 ㅣ어디로 전송할지 결정
	- 헤더 수정 가능
	- 콘텐트 기반 라우팅을 통해 다수의 서버로 구성된 어플리케이션이 콘텐트의 내용에 따라 특정 서비스로 라우팅할 수 있다.
- 클래식 로드 밸런서 (Classic Load Balacner)
	- 네트워크 로드 밸런싱 및 어플리케이션 로드 밸런싱 모두 지원

## 로드 밸런서의 핵심 개념 및 용어
- 하나의 로드밸런서는 콘텐트 기반 라우팅 지원
- ELB 하나 당 어플리케이션 1개만 호스팅 가능
	- DNS 사용으로 다수의 어플리케이션 호스팅 가능
	- 이용되는 로드밸런서 비용만큼 비용 지불
- 어플리케이션 로드밸런서를 이용하면, 콘텐트 기반으로 라우팅이 가능하므로 ELB의 개수를 줄일 수 있다.
- ECS를 이용하면 동적 포트 매핑으로 로드밸런서의 포트 등록 업무를 자동으로 처리한다.
- 로드 밸런서의 핵심 구성 요소
	- 리스너 : 트래픽이 유입되는 로드밸런서의 리스너의 연결부분에 대한 프로토콜과 포트 정의, 최대 10개의 리스너 지원
	- 타깃 그룹과 타깃
		- 타깃 : 로드밸런싱 타깃을 논리적으로 구현
		- 타깃 그룹은 로드밸런서와 별개로 존재
		- 필요할 때를 대비해 타깃 그룹을 미리 생성 가능하다.
		- 타깃 그룹은 리전 기반
	- 규칙
		- 리스너와 타깃 그룹 연결
		- 조건과 동작으로 구성
		- 경로 기반 규칙 (반드시 경로패턴 포맷을 따른다)
		- 규칙 조건 - 호스트 조건 / 경로 조건
	- 헬스 체크
		- 타깃과 타깃그룹이 항상 문제 없이 동작할 수 있도록, 상태확인
		- HealthCheckIntervalSeconds - 로드밸런서가 체크 요청 전송시간
		- 상태값
			- Inital : 타깃 등록 과정 또는 타깃에 대한 초기 헬스 체크
			- Healthy : 타깃이 건강함
			- Unhealthy : 헬스체크에 반응하지 않거나 체크 실패
			- Unused : 타깃이 타깃 그룹에 등록되지 않고, 규칙에서 사용되지 않거나 타깃이 로드밸런서를 사용할 수 없는 AZ에 존재
			- Draining : 타깃이 등록 해제됐고,연결헤제 절차가 진행중임
	- 다중 AZ 활용
		- 하나의 AZ 다운 시 다른 AZ에서 오토 스케일링 -> 대응 가능
		- 세션 상태 정보등의 관리 -> Dynamo DB 이용
		- Java 실행시 이슈
			- 자바 기반 어플리케이션은 DNS에 있는 서버 IP주소를 임시 저장 -> 매번 동일한 인스턴스로 트래픽 재전송 -> 크로스 존 로드밸런싱으로 문제해결
				- 크로스 존 로드밸런싱 : 처리용청은 다중 A에 균등 분배
