# 03-2. AWS 가상 보안 클라우드 ( VPC ) - 시큐리티 그룹, NACL, 피어링, 엔드포인트, DHCP

## 시큐리티 그룹
- VPC에서 실행되는 어떤 인스턴스에도 할당할 수 있는 가상 방화벽
- 특정 인스턴스의 내부 또는 외부로 이동하는 트래픽 관리
- 서브넷 다누이가 아닌 인스턴스 레벨에서 동작 -> 하나의 서브넷에 다른 인스턴스마다 다른 시큐리티 그룹 지정 가능
- 새로운 인스턴스 생성마다 시큐리티 그룹 추가 필요
- 스테이트풀 속성을 지니며, IP 주소, 포트, 트래픽의 인바운드 및 아웃바운드 규칙 정의
	- 스테이트풀 : 네틍워크내에서 일어난 일들을 기억하고 참조한다.
- 언제든지 트래픽의 접근허용 또는 거절 규칙을 변경할 수 있지만, 거절 규칙을 작성할 수는 없다.

## 네트워크 액세스 컨트롤 리스트 ( NACL )
- VPC의 서브넷 레벨에 적용할 수 있는 추가적인 방화벽
- IP 주소, 포트, 프로토콜, 서브넷 허용/거부 규칙을 통합한 스테이트리스 방화벽
- 아마존 VPC는 기본적으로 NACL 제공
- IPv4 및 IPv6 d인바운드, 아웃바운드 트래픽 필터링
- 서브넷과 연결돼 있으므로 VPC의 모든 서브넷에는 NACL을 할당해야 한다.
- 명시적으로 서브넷에 NACL을 할당하지 않으면, 서브넷은 자동으로 기본 NACL과 연결된다.
- 트래픽에 대한 규칙을 숫자형 목록으로 정의하며, 숫자가 낮을수록 우선순위가 높다.

### 시큐리티 그룹과 NACL 차이점
- 시큐리티 그룹
	- 인스턴스 레벨
	- 스테이트풀
	- 리턴 트래픽을 기본적으로 허용
	- 허용규칙만 추가
	- 모든 규칙은 트패릭 허용 전에 평가
	- 리전당 500개의 시큐리티 그룹 생성 가능
	- 각 시큐리티 그룹마다 50개의 인바운드/아웃바운드 규칙 추가 가능
	- 네트워크 인터페이스 당 최대 시큐리티 그룹의 수는 5개
		- AWS Support 요청을 통해 16개 까지 추가 가능
- NACL
	- 서브넷 레벨
	- 스테이트리스
	- 리턴 트래픽을 기본적으로 거부
	- 허용 및 거부 규칙 모두 추가 가능
	- 순번에 따른 우선순위로 평가

## 아마존 VPC 피어링
- 여러VPC 간의 통신 또는 리소스 공유
- 서로 다른 계정의 VPC 피어링 가능
- 동일한 리전 내에서만 가능
- 피어링을 위한 특수한 하드웨어 존재

## 아마존 VPC 엔드포인트
- VPC 외부에서 실행되는 서비스 -> ex. S3
- S3를 VPC에 연결하려면 인터넷과 데이터 센터 전용 네트워크 두개를 함께 연결해야 한다.
- VPC 엔드포인트 환경설정 방법
	1. VPC에서 생성하려는 엔드포인트와 연결하려는 서비스 정의
		- 엔드포인트에 정책 규칙 및 라우트 테이블 엔트리 추가
	2. VPC와 다른 서비스의 트래픽을 라우팅하기 위한 라우트 테이블 엔트리 작성
-> VPC 엔드포인트를 이용하면 프라이빗 서브넷의 라우트 테이블에 관련 엔트리를 쉽게 추가하며, S3에 바로 연결할 수 있다. => 인터넷 연결을 위해 퍼블릭 서브넷에 접근하지 않아도 된다.
- VPC 엔드포인트 이용시 장점
	- 비용절감 - 프라이빗 서브넷에 EC2 인스턴스가 있고, S3와 연결시에 VPC 엔트포인트로 바로 연결 가능하므로, 데이터 비용이 들지 않는다.
		- VPC 엔드포인트가 없다면, 퍼브릭 서브넷에 있는 S3의 데이터를 EC2인스턴스가 있는 프라이빗 서브넷으로 전송하려면 트래픽은 인터넷으로 연결된 리전별 서비스인 S3에 접속하기 위해 VPC를 벗어나야 하고, 데이터를 포함한 트래픽이 다시 VPC로 들어오는 비용이 발생한다.

## DHCP 옵션 세트
- DHCP : Dynamic Host Configuration Protocol
- 아마존은 VPC 생성 시 자동으로 DHCP 옵션세트를 추가한다.
- 기본 도메인 네임, DNS 서버 등 VPC에 있는 인스턴스의 호스트 설정에 사용
- AWS는 AWS 디렉터리 서비스 사용시 VPC 설정에서 DHCP 옵션 세트를 사용할 것을 권장
	- VPC에 있는 모든 인스턴스는 해당 도메인 네임을 통해 특정 도메인 또는 DNS를 가리킬 수 있다.
- 도메인 네임서버가 기본적으로 AmazonProvidedDNS를 가리키도록 하는 옵션과 리전에 대한 도메인 네임옵션을 함께 제공한다.
- 생성된 DHCP는 수정할 수 없다.
- 파라미터 
	- domain-name-server: 도메인 네임버서의 IP 주소 또는 AmazonProvidedDNS
	- domain-name
	- ntp-severs : NTP Network Time Protocol 서버의 IP 주소로 최대 4개 추가 가능
	- netbios-name-servers : NetBIOS 네임서버의 IP 주소로 최대 4개 추가 가능

## VPC 연결하기
- Virtual private Gateway
	- 기본적으로 VPC에서 실행한 EC2는 자체 네트워크를 사용하는 기업 데이터 센터와 소통할 수 없다. -> VPG를 VPC에 부착하고, Custom Route Table을 작성 후 시큐리티그룹 규칙을 업데이트한다.
	- VPG는 아마존에서 제공하는 VPN 연결 서비스로서 아마존측의 트래픽을 관리한다.
- Customer Gateway
	- 기업 데이터 센터측 트래픽 관리
	- VPN 연결부분에 있는 물리적 디바이스, 소프트웨어 어플리케이션
	- 기업 데이터 센터측에서 연결된 부분의 앵커와 같은 역할을 담당한다.

## 기본설정 VPC
- 리전별 생성
- 다이나믹 프라이빗 IP, 다이나믹 퍼블릭 IP, DNS 네임 제공
- 서브넷 추가 및 라우트 테이블 규칙 변경 가능
- 시큐리티 그룹, NACL, 라우팅 등 네트워크 컨트롤 추가 생성
- 기업 네트워크 간의 하드웨어 VPN  옵션 설정