# 01. 스프링 클라우드 - 웹서비스 확장 전략, 서비스 확장, 부하분산

https://spring.io/projects/spring-cloud

- HA : 고가용성
- Resilience : 회복 탄력성

## 웹 서비스 확장 전략

- 솔루션 개발 : B2B. 기업 대 기업
- 서비스 개발 : B2C. 기업 대 사용자. 웹서비스 확장이 사용된다.
- SI 개발

## 서비스 확장

- 스케일 업을 통한 서비스 확장 : 한 대의 서버의 성능을 업그레이드 한다.
- 스케일 아웃을 통한 서비스 확장 : 여러 대의 서버를 구축하여 트래픽을 분산한다.
  - 블루그린 배포 방법 : 스케일 아웃 시 배포 방식
    - 사용자 트래픽을 이전 버전과 거의 동일한 새 버전으로 점진적으로 이전하는 릴리스 모델
    - 이전 버전을 blue, 새 버전을 green 환경으로 부른다.
      - 프로덕션 트래픽이 blue에서 green으로 완전히 이전되면 blue는 롤백에 대비하여 대기 상태로 두거나 다음 업데이트의 템플릿으로 사용된다.
      - blue 환경에서 green 환경으로 request를 변경하는 방법 => 라우터 변경(라우터는 Nginx가 역할 수행 가능)

## 읽기 요청 부하 분산 => 캐시, 클러스터링, 레플리카, 샤딩

- api server를 거쳐 DB server로 읽기 요청이 들어갈 때, 부하 분산을 위해 api에 캐시처리를 한다.
  - 캐시에 저장된 값이 있으면, 동일한 요청에 대해서 DB server에 접근하지 않아 부하를 줄일 수 있다.
- 단일 서버일 경우
  - api 서버가 하나일 경우, api 서버 자체에 캐시 처리를하여 DB Server의 부하를 줄일 수 있다.
- 다중 서버일 경우
  - 다중 서버일 경우, L7 스위치나 로드밸런서를 통해 부하를 분산시킨다.
  - api 서버가 여러 개일 경우, api 서버 자체에 캐시처리를 하기 보다는 Redis 등의 Cache Server를 따로 두어 부하를 줄인다.

- DB 서버의 부하를 줄이기 위해 확장하는 방법

  - 클러스터링과 레플리카
    - HA: 고가용성 - 동일한 DB 서버를 여러 대 두는 방법
    - 클러스터링 : 동일한 DB 서버를 여러 대를 갖고, 그 아래 DB 서버들을 연결하여 군집하여 사용하는 형태
    - 레플리카 : 동일한 DB 서버를 여러 대를 갖고, 읽기 전용 DB 서버등으로 사용하는 형태 (읽기 요청에 효과적)

- 샤딩

  > 하나의 거대한 데이터베이스나 네트워크 시스템을 여러 개의 작은 조각으로 나누어 분산 저장하여 관리하는 것을 말한다. 이는 단일의 데이터를 다수의 데이터베이스로 쪼개어 나누는 걸 말하는데, 단일의 데이터베이스에서 저장하기 너무 클 때 사용하여 데이터를 구간별로 쪼개어 나눔으로써 노드에 무겁게 가지고 있던 데이터를 빠르게 검증할 수 있어 빠른 트랜잭션 속도를 향상시킬 수 있다. 샤딩을 통해 나누어진 블록들의 구간(epoch)을 샤드(shard)라고 부른다.

  - 클러스터링보다는 샤딩을 많이 사용한다.
  - 클러스터링을 할 경우, 장비도 많이 필요하고 불필요한 내용들을 DB 서버가 모두 공유하는 비효율적인 문제가 생긴다.

## 쓰기 요청 부하 분산

- 파일을 업로드 하는 경우
  - 파일 업로드 서버를 따로 만들고
  - 이미지 조회, 게시글 조회 등은 API 서버를 만든다.

## 분산환경에서 메시지 큐 활용

- 파일 업로드 등의 이벤트도 요청이 많아지면 부하가 발생한다. => 메시지 큐 처리가 필요하다.
  - Kafka
  - RabbitMQ
- 메시지 큐의 구조
  - Broker
  - Exchange
  - Queue 